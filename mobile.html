<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>TfL Spend & Savings</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fb;
            min-height: 100vh;
            color: #1a1a2e;
            padding-bottom: 80px;
        }

        /* Sticky Header */
        .header {
            background: #fff;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e5e7eb;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-left { display: flex; align-items: center; gap: 10px; }

        .roundel-sm {
            width: 32px;
            height: 32px;
            background: #003688;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .roundel-sm::after {
            content: '';
            position: absolute;
            width: 28px;
            height: 8px;
            background: #dc241f;
            border-radius: 2px;
        }
        .roundel-sm span {
            position: relative;
            z-index: 2;
            color: #fff;
            font-weight: 800;
            font-size: 0.45em;
            letter-spacing: 0.5px;
        }

        .header h1 {
            font-size: 1.15em;
            font-weight: 800;
            color: #1a1a2e;
        }

        .header-btns { display: flex; gap: 8px; }

        .header-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6px 10px;
            color: #6b7280;
            font-size: 0.75em;
            cursor: pointer;
            font-family: inherit;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .mini-stat {
            background: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .mini-stat .label {
            font-size: 0.6em;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .mini-stat .value {
            font-size: 1.25em;
            font-weight: 800;
            margin-top: 2px;
        }

        .mini-stat .sub {
            font-size: 0.6em;
            color: #9ca3af;
            margin-top: 1px;
        }

        .mini-stat .value.green { color: #059669; }
        .mini-stat .value.red { color: #dc2626; }
        .mini-stat .value.blue { color: #2563eb; }
        .mini-stat .value.indigo { color: #4f46e5; }
        .mini-stat .value.amber { color: #d97706; }

        /* Google Status */
        .google-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 14px;
            margin: 12px 16px 0;
            font-size: 0.8em;
        }

        .google-bar .status-info { color: #6b7280; }
        #lastSyncText { font-size: 0.8em; color: #9ca3af; }
        .google-bar .google-btns { display: flex; gap: 8px; }

        .g-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.82em;
            cursor: pointer;
            font-family: inherit;
        }
        .g-btn.connect { background: #003688; color: #fff; border-color: #003688; }
        .g-btn.sync { background: #059669; color: #fff; border-color: #059669; }

        /* Import summary */
        .import-summary {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.82em;
            margin: 8px 16px 0;
        }
        .import-summary.success { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
        .import-summary.error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }

        /* Tab content area */
        .tab-content {
            display: none;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card h3 {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        /* Verdict */
        #verdict { display: none; }

        .verdict-box {
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            margin-bottom: 12px;
        }
        .verdict-box.good { background: #ecfdf5; border: 1px solid #a7f3d0; }
        .verdict-box.warn { background: #fffbeb; border: 1px solid #fde68a; }
        .verdict-amount { display: block; font-size: 1.15em; font-weight: 800; }
        .verdict-box.good .verdict-amount { color: #059669; }
        .verdict-box.warn .verdict-amount { color: #d97706; }
        .verdict-desc { display: block; font-size: 0.78em; color: #6b7280; margin-top: 4px; }

        .verdict-sub-text {
            font-size: 0.72em;
            color: #9ca3af;
            text-align: center;
            margin-bottom: 12px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-box {
            background: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .stat-box.payg { border-color: #dbeafe; background: #eff6ff; }
        .stat-box.pass { border-color: #e0e7ff; background: #eef2ff; }
        .stat-label { font-size: 0.6em; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 1.25em; font-weight: 800; margin-top: 2px; }
        .stat-value.blue { color: #2563eb; }
        .stat-value.indigo { color: #4f46e5; }
        .stat-value.green { color: #059669; }
        .stat-value.red { color: #dc2626; }
        .stat-value.amber { color: #d97706; }
        .stat-sub { font-size: 0.58em; color: #9ca3af; margin-top: 2px; }

        .stats-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        /* Cap meter (compact) */
        .cap-container { display: flex; align-items: center; gap: 16px; }
        .cap-ring-mobile { position: relative; width: 120px; height: 120px; flex-shrink: 0; }
        .cap-ring-mobile svg { transform: rotate(-90deg); }
        .cap-bg { stroke: #f3f4f6; }
        .cap-progress { stroke: #2563eb; transition: all 0.5s; }
        .cap-progress.capped { stroke: #059669; filter: drop-shadow(0 0 12px rgba(5,150,105,0.3)); }
        .cap-center {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .cap-amount { font-size: 1.3em; font-weight: 800; color: #1a1a2e; }
        .cap-label { font-size: 0.7em; color: #9ca3af; }
        .cap-info { flex: 1; }
        .cap-status {
            padding: 10px 14px;
            border-radius: 10px;
            background: #eff6ff;
            border: 1px solid #dbeafe;
            color: #2563eb;
            font-size: 0.85em;
            font-weight: 500;
            text-align: center;
        }
        .cap-status.capped {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #059669;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Journey rows */
        .journey-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f9fafb;
            margin-bottom: 6px;
            border: 1px solid transparent;
        }
        .journey-row.compact { padding: 8px 10px; }
        .journey-left { display: flex; align-items: center; gap: 10px; }
        .journey-icon { font-size: 1.1em; }
        .journey-desc { font-weight: 500; font-size: 0.85em; color: #1a1a2e; }
        .journey-row.compact .journey-desc { font-size: 0.78em; }
        .journey-time { font-size: 0.7em; color: #9ca3af; display: flex; align-items: center; gap: 4px; }
        .journey-right { display: flex; align-items: center; gap: 8px; }
        .journey-cost { font-weight: 700; font-size: 0.9em; color: #1a1a2e; }
        .journey-row.compact .journey-cost { font-size: 0.8em; }
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.3;
            font-size: 0.8em;
        }

        .tag { font-size: 0.6em; padding: 2px 5px; border-radius: 4px; font-weight: 600; }
        .tag.csv { background: #eef2ff; color: #4f46e5; }

        /* Day groups (history) */
        .day-group { margin-bottom: 14px; }
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-wrap: wrap;
            gap: 6px;
        }
        .day-date { font-weight: 600; color: #374151; font-size: 0.85em; }
        .day-meta { display: flex; align-items: center; gap: 6px; }
        .day-cost { font-weight: 700; font-size: 0.85em; color: #1a1a2e; }
        .day-journeys { padding-left: 12px; }
        .cap-note { font-size: 0.7em; color: #059669; font-weight: 500; }

        .badge {
            font-size: 0.62em;
            padding: 2px 8px;
            border-radius: 16px;
            font-weight: 600;
        }
        .badge.good { background: #ecfdf5; color: #059669; }
        .badge.warn { background: #fffbeb; color: #d97706; }

        /* Analysis rows */
        .analysis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 6px;
        }
        .analysis-row.good { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .analysis-row.warn { background: #fffbeb; border: 1px solid #fde68a; }
        .analysis-left { display: flex; align-items: center; gap: 10px; }
        .analysis-icon { font-size: 1em; }
        .analysis-date { font-weight: 600; font-size: 0.82em; color: #1a1a2e; }
        .analysis-sub { font-size: 0.7em; color: #6b7280; }
        .analysis-right { text-align: right; }
        .analysis-cost { font-weight: 800; font-size: 0.88em; }
        .analysis-cost.good { color: #059669; }
        .analysis-cost.warn { color: #d97706; }
        .analysis-vs { font-size: 0.68em; color: #9ca3af; }
        .analysis-cap { font-size: 0.68em; color: #2563eb; }

        /* Chart */
        .chart-container { min-height: 250px; }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
            font-size: 0.72em;
            color: #6b7280;
        }
        .legend-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        .legend-line {
            display: inline-block;
            width: 16px;
            height: 0;
            border-top: 2px dashed #d97706;
            margin-right: 4px;
            vertical-align: middle;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: #9ca3af;
            font-style: italic;
            font-size: 0.88em;
        }
        .empty-state small { font-size: 0.85em; color: #d1d5db; }

        /* Add Journey Panel */
        .journey-option {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #1a1a2e;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.15s;
            font-size: 1em;
            text-align: left;
            font-family: inherit;
        }
        .journey-option:active { background: #f3f4f6; transform: scale(0.98); }
        .journey-option .opt-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
        }
        .journey-option .opt-label { font-weight: 600; }
        .journey-option .opt-sub { font-size: 0.78em; color: #9ca3af; }
        .journey-option.bus { border-color: #a7f3d0; }
        .journey-option.bus .opt-icon { background: #ecfdf5; }
        .journey-option.bus .opt-label { color: #059669; }
        .journey-option.peak { border-color: #fecaca; }
        .journey-option.peak .opt-icon { background: #fef2f2; }
        .journey-option.peak .opt-label { color: #dc2626; }
        .journey-option.offpeak { border-color: #dbeafe; }
        .journey-option.offpeak .opt-icon { background: #eff6ff; }
        .journey-option.offpeak .opt-label { color: #2563eb; }

        /* Bottom Tab Nav */
        .tab-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            display: flex;
            border-top: 1px solid #e5e7eb;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex: 1;
            padding: 10px 4px;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 0.62em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            transition: all 0.15s;
            font-family: inherit;
        }

        .tab-btn.active { color: #003688; }

        .tab-btn .icon { font-size: 1.6em; }

        /* Scroll panels */
        .scroll-panel { max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* Desktop link */
        .desktop-link {
            text-align: center;
            padding: 16px;
            font-size: 0.8em;
        }
        .desktop-link a { color: #003688; text-decoration: none; }

        /* Hidden file input */
        .hidden-input { display: none; }
    </style>
</head>
<body>
    <!-- Sticky Header -->
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <div class="roundel-sm"><span>TfL</span></div>
                <h1>Spend & Savings</h1>
            </div>
            <div class="header-btns">
                <input type="file" id="csvInput" class="hidden-input" accept=".csv" onchange="handleCSVImport(event)">
                <button class="header-btn" onclick="document.getElementById('csvInput').click()">üì• CSV</button>
                <button class="header-btn" onclick="exportCSV()">üì§ Export</button>
            </div>
        </div>
        <div class="quick-stats">
            <div class="mini-stat">
                <div class="label">Today's Spend</div>
                <div class="value blue" id="quickToday">¬£0.00</div>
                <div class="sub" id="quickTodayJourneys">0 journeys</div>
            </div>
            <div class="mini-stat" id="quickVerdictBox">
                <div class="label">Annual Pass</div>
                <div class="value green" id="quickVerdict">‚Äî</div>
                <div class="sub" id="quickVerdictSub">Import data to see</div>
            </div>
        </div>
    </div>

    <!-- Google Sheets Status -->
    <div class="google-bar">
        <div class="status-info">
            <div id="statusText">Not connected</div>
            <div id="lastSyncText"></div>
        </div>
        <div class="google-btns">
            <button class="g-btn sync" id="syncBtn" onclick="syncData()" style="display:none">üîÑ Sync</button>
            <button class="g-btn connect" id="connectBtn" onclick="authorizeGoogle()">Connect</button>
        </div>
    </div>

    <div id="importSummary" class="import-summary"></div>

    <!-- Tab: Dashboard -->
    <div id="tabDashboard" class="tab-content active">
        <div id="verdict" class="card">
            <div id="verdictBox" class="verdict-box"></div>
            <div class="verdict-sub-text" id="verdictSub"></div>
            <div class="stats-row">
                <div class="stat-box payg">
                    <div class="stat-label">PAYG Would Cost</div>
                    <div class="stat-value blue" id="statPayg">¬£0.00</div>
                    <div class="stat-sub" id="statPaygDays">0 travel days</div>
                </div>
                <div class="stat-box pass">
                    <div class="stat-label">Annual Pass Cost</div>
                    <div class="stat-value indigo" id="statPass">¬£0.00</div>
                    <div class="stat-sub" id="statPassDays">0 days</div>
                </div>
            </div>
            <div class="stats-row-4">
                <div class="stat-box">
                    <div class="stat-label">Pass Worth It</div>
                    <div class="stat-value green" id="statPassWin">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">PAYG Cheaper</div>
                    <div class="stat-value red" id="statPaygWin">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">No Travel</div>
                    <div class="stat-value amber" id="statNoTravel">0</div>
                    <div class="stat-sub" id="statNoTravelCost">¬£0 wasted</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Journeys</div>
                    <div class="stat-value" id="statTotalJourneys">0</div>
                    <div class="stat-sub" id="statTotalJourneysSub">0 days</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Today's Cap Meter</h3>
            <div class="cap-container">
                <div class="cap-ring-mobile">
                    <svg width="120" height="120">
                        <circle cx="60" cy="60" r="52" stroke-width="10" fill="none" class="cap-bg" />
                        <circle id="capCircle" cx="60" cy="60" r="52" stroke-width="10" fill="none" stroke-linecap="round" class="cap-progress" />
                    </svg>
                    <div class="cap-center">
                        <div id="capAmount" class="cap-amount">¬£0.00</div>
                        <div class="cap-label">of ¬£8.90</div>
                    </div>
                </div>
                <div class="cap-info">
                    <div id="capStatus" class="cap-status">¬£8.90 until cap</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Today's Journeys</h3>
            <div id="todayList"></div>
        </div>
    </div>

    <!-- Tab: Add Journey -->
    <div id="tabAdd" class="tab-content">
        <div class="card">
            <h3>Log a Journey</h3>
            <button class="journey-option bus" onclick="addJourney('bus')">
                <span class="opt-icon">üöå</span>
                <div><div class="opt-label">Bus</div><div class="opt-sub">¬£1.75 ¬∑ Hopper eligible</div></div>
            </button>
            <button class="journey-option peak" onclick="addJourney('tube-peak')">
                <span class="opt-icon">üöá</span>
                <div><div class="opt-label">Underground (Peak)</div><div class="opt-sub">¬£3.10 ¬∑ Weekday 6:30‚Äì9:30, 16:00‚Äì19:00</div></div>
            </button>
            <button class="journey-option offpeak" onclick="addJourney('tube-offpeak')">
                <span class="opt-icon">üöá</span>
                <div><div class="opt-label">Underground (Off-Peak)</div><div class="opt-sub">¬£3.00 ¬∑ All other times</div></div>
            </button>
        </div>
        <div class="desktop-link">
            <a href="index.html">Switch to Desktop Version</a>
        </div>
    </div>

    <!-- Tab: History -->
    <div id="tabHistory" class="tab-content">
        <div class="card">
            <h3>Journey History</h3>
            <div id="historyList" class="scroll-panel"></div>
        </div>
    </div>

    <!-- Tab: Chart -->
    <div id="tabChart" class="tab-content">
        <div class="card">
            <h3>Daily PAYG Cost vs Annual Pass</h3>
            <div id="mobileChart" class="chart-container"></div>
            <div class="chart-legend">
                <span><span class="legend-dot" style="background:#059669"></span>Pass saved money</span>
                <span><span class="legend-dot" style="background:#dc2626"></span>PAYG cheaper</span>
                <span><span class="legend-line"></span>Pass: ¬£4.91/day</span>
            </div>
        </div>
    </div>

    <!-- Tab: Analysis -->
    <div id="tabAnalysis" class="tab-content">
        <div class="card">
            <h3>Daily Breakdown</h3>
            <div id="analysisList" class="scroll-panel"></div>
        </div>
    </div>

    <!-- Bottom Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="switchMobileTab('Dashboard', this)">
            <span class="icon">üè†</span>
            <span>Home</span>
        </button>
        <button class="tab-btn" onclick="switchMobileTab('Add', this)">
            <span class="icon">‚ûï</span>
            <span>Add</span>
        </button>
        <button class="tab-btn" onclick="switchMobileTab('History', this)">
            <span class="icon">üìã</span>
            <span>History</span>
        </button>
        <button class="tab-btn" onclick="switchMobileTab('Chart', this)">
            <span class="icon">üìä</span>
            <span>Chart</span>
        </button>
        <button class="tab-btn" onclick="switchMobileTab('Analysis', this)">
            <span class="icon">üîç</span>
            <span>Analysis</span>
        </button>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script src="app.js"></script>
    <script>
        function switchMobileTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-nav .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + tabName).classList.add('active');
            btn.classList.add('active');
            if (tabName === 'Chart') renderMobileChart();
        }

        const _origDisplayDashboard = displayDashboard;
        displayDashboard = function () {
            _origDisplayDashboard();
            updateMobileQuickStats();
        };

        function updateMobileQuickStats() {
            const todayCost = getTodayCost();
            const todayJourneys = getTodayJourneys();
            const summaries = getDailySummaries(journeys);
            const stats = getOverallStats(summaries);

            document.getElementById('quickToday').textContent = formatCurrency(todayCost);
            document.getElementById('quickTodayJourneys').textContent = `${todayJourneys.length} journeys`;

            if (journeys.length > 0) {
                const isPassWorthIt = stats.savings <= 0;
                const verdictEl = document.getElementById('quickVerdict');
                const verdictSub = document.getElementById('quickVerdictSub');

                if (isPassWorthIt) {
                    verdictEl.textContent = '‚úÖ Worth it';
                    verdictEl.className = 'value green';
                    verdictSub.textContent = `Saving ${formatCurrency(Math.abs(stats.savings))}`;
                } else {
                    verdictEl.textContent = '‚ö†Ô∏è Not yet';
                    verdictEl.className = 'value amber';
                    verdictSub.textContent = `PAYG saves ${formatCurrency(stats.savings)}`;
                }
            }

            updateMobileCapMeter(todayCost);
        }

        function updateMobileCapMeter(todayCost) {
            const capCircle = document.getElementById('capCircle');
            if (!capCircle) return;
            const radius = 52;
            const circumference = 2 * Math.PI * radius;
            const progress = Math.min((todayCost / 8.90) * 100, 100);
            const isCapped = todayCost >= 8.90;
            capCircle.style.strokeDasharray = circumference;
            capCircle.style.strokeDashoffset = circumference * (1 - progress / 100);
            capCircle.setAttribute('class', isCapped ? 'cap-progress capped' : 'cap-progress');
        }

        let mobileChartInstance = null;

        function renderMobileChart() {
            const summaries = getDailySummaries(journeys);
            const container = document.getElementById('mobileChart');
            if (!container || summaries.length < 2) return;

            const reversed = [...summaries].reverse();
            const labels = reversed.map(s => s.dateShort);
            const costs = reversed.map(s => parseFloat(s.paygCost.toFixed(2)));
            const colors = reversed.map(s => s.passWorthIt ? '#059669' : '#dc2626');

            if (mobileChartInstance) mobileChartInstance.destroy();

            const options = {
                series: [{ name: 'PAYG Cost', data: costs }],
                chart: {
                    type: 'bar',
                    height: 250,
                    toolbar: { show: false },
                    fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                    background: 'transparent',
                },
                colors: ['#2563eb'],
                plotOptions: {
                    bar: { borderRadius: 3, columnWidth: '70%', distributed: true }
                },
                fill: { colors: colors },
                xaxis: {
                    categories: labels,
                    labels: {
                        style: { colors: '#9ca3af', fontSize: '9px' },
                        rotate: -45,
                        rotateAlways: summaries.length > 7,
                    },
                },
                yaxis: {
                    labels: {
                        style: { colors: '#9ca3af' },
                        formatter: val => '¬£' + val.toFixed(0),
                    }
                },
                grid: { borderColor: '#e5e7eb', strokeDashArray: 4 },
                annotations: {
                    yaxis: [{
                        y: DAILY_PASS,
                        borderColor: '#d97706',
                        borderWidth: 2,
                        strokeDashArray: 6,
                        label: {
                            text: `Pass: ${formatCurrency(DAILY_PASS)}/day`,
                            position: 'front',
                            style: {
                                color: '#fff',
                                background: '#d97706',
                                fontSize: '10px',
                                padding: { left: 6, right: 6, top: 3, bottom: 3 },
                            }
                        }
                    }]
                },
                dataLabels: { enabled: false },
                legend: { show: false },
                tooltip: {
                    theme: 'light',
                    y: { formatter: val => '¬£' + val.toFixed(2) },
                },
            };

            mobileChartInstance = new ApexCharts(container, options);
            mobileChartInstance.render();
        }
    </script>
</body>
</html>
