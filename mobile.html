<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>TfL Spend & Savings</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root, [data-theme="light"] {
            --bg: #f8f9fb; --bg-card: #fff; --bg-card-hover: #f3f4f6;
            --bg-muted: #f9fafb; --bg-tab: #f3f4f6; --bg-tab-active: #fff;
            --border: #e5e7eb; --border-light: #f3f4f6;
            --text: #1a1a2e; --text-secondary: #374151; --text-muted: #6b7280;
            --text-faint: #9ca3af; --text-faintest: #d1d5db;
            --blue: #2563eb; --indigo: #4f46e5; --green: #059669; --red: #dc2626; --amber: #d97706;
            --shadow: 0 1px 3px rgba(0,0,0,0.04);
            --good-bg: #ecfdf5; --good-border: #a7f3d0;
            --warn-bg: #fffbeb; --warn-border: #fde68a;
            --payg-bg: #eff6ff; --payg-border: #dbeafe;
            --pass-bg: #eef2ff; --pass-border: #e0e7ff;
            --analysis-good-bg: #f0fdf4; --analysis-good-border: #bbf7d0;
            --analysis-warn-bg: #fffbeb; --analysis-warn-border: #fde68a;
            --badge-good-bg: #ecfdf5; --badge-warn-bg: #fffbeb;
            --tag-bg: #eef2ff; --tag-color: #4f46e5;
            --cap-bg-stroke: #f3f4f6;
            --cap-status-bg: #eff6ff; --cap-status-border: #dbeafe; --cap-status-color: #2563eb;
            --cap-capped-bg: #ecfdf5; --cap-capped-border: #a7f3d0; --cap-capped-color: #059669;
            --success-bg: #ecfdf5; --success-border: #a7f3d0; --success-color: #065f46;
            --error-bg: #fef2f2; --error-border: #fecaca; --error-color: #991b1b;
            --nav-bg: #fff; --nav-active: #003688;
        }

        [data-theme="dark"] {
            --bg: #0f1117; --bg-card: #1a1d2e; --bg-card-hover: #232640;
            --bg-muted: #1e2130; --bg-tab: #1a1d2e; --bg-tab-active: #232640;
            --border: #2a2d42; --border-light: #22253a;
            --text: #e2e8f0; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
            --text-faint: #64748b; --text-faintest: #475569;
            --blue: #60a5fa; --indigo: #818cf8; --green: #34d399; --red: #f87171; --amber: #fbbf24;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --good-bg: rgba(52,211,153,0.1); --good-border: rgba(52,211,153,0.25);
            --warn-bg: rgba(251,191,36,0.1); --warn-border: rgba(251,191,36,0.25);
            --payg-bg: rgba(96,165,250,0.1); --payg-border: rgba(96,165,250,0.2);
            --pass-bg: rgba(129,140,248,0.1); --pass-border: rgba(129,140,248,0.2);
            --analysis-good-bg: rgba(52,211,153,0.08); --analysis-good-border: rgba(52,211,153,0.2);
            --analysis-warn-bg: rgba(251,191,36,0.06); --analysis-warn-border: rgba(251,191,36,0.15);
            --badge-good-bg: rgba(52,211,153,0.15); --badge-warn-bg: rgba(251,191,36,0.15);
            --tag-bg: rgba(129,140,248,0.15); --tag-color: #a5b4fc;
            --cap-bg-stroke: rgba(255,255,255,0.08);
            --cap-status-bg: rgba(96,165,250,0.12); --cap-status-border: rgba(96,165,250,0.2); --cap-status-color: #60a5fa;
            --cap-capped-bg: rgba(52,211,153,0.12); --cap-capped-border: rgba(52,211,153,0.2); --cap-capped-color: #34d399;
            --success-bg: rgba(52,211,153,0.1); --success-border: rgba(52,211,153,0.25); --success-color: #6ee7b7;
            --error-bg: rgba(248,113,113,0.1); --error-border: rgba(248,113,113,0.25); --error-color: #fca5a5;
            --nav-bg: rgba(15,17,23,0.95); --nav-active: #818cf8;
        }

        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); padding-bottom: 80px; transition: background 0.3s, color 0.3s; }

        .header { background: var(--bg-card); padding: 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); transition: background 0.3s; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .roundel-sm { width: 32px; height: 32px; background: #003688; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .roundel-sm::after { content: ''; position: absolute; width: 28px; height: 8px; background: #dc241f; border-radius: 2px; }
        .roundel-sm span { position: relative; z-index: 2; color: #fff; font-weight: 800; font-size: 0.45em; letter-spacing: 0.5px; }
        .header h1 { font-size: 1.15em; font-weight: 800; color: var(--text); }
        .header-btns { display: flex; gap: 8px; }
        .header-btn { background: var(--bg-muted); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; color: var(--text-muted); font-size: 0.75em; cursor: pointer; font-family: inherit; transition: background 0.3s; }

        .quick-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mini-stat { background: var(--bg-muted); border: 1px solid var(--border-light); border-radius: 10px; padding: 10px; text-align: center; transition: background 0.3s; }
        .mini-stat .label { font-size: 0.6em; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .mini-stat .value { font-size: 1.25em; font-weight: 800; margin-top: 2px; }
        .mini-stat .sub { font-size: 0.6em; color: var(--text-faint); margin-top: 1px; }
        .mini-stat .value.green { color: var(--green); }
        .mini-stat .value.red { color: var(--red); }
        .mini-stat .value.blue { color: var(--blue); }
        .mini-stat .value.indigo { color: var(--indigo); }
        .mini-stat .value.amber { color: var(--amber); }

        .google-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; margin: 12px 16px 0; font-size: 0.8em; transition: background 0.3s; }
        .google-bar .status-info { color: var(--text-muted); }
        #lastSyncText { font-size: 0.8em; color: var(--text-faint); }
        .google-bar .google-btns { display: flex; gap: 8px; }
        .g-btn { padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.82em; cursor: pointer; font-family: inherit; }
        .g-btn.connect { background: #003688; color: #fff; border-color: #003688; }
        .g-btn.sync { background: #059669; color: #fff; border-color: #059669; }

        .import-summary { display: none; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 10px; font-size: 0.82em; margin: 8px 16px 0; }
        .import-summary.success { background: var(--success-bg); border: 1px solid var(--success-border); color: var(--success-color); }
        .import-summary.error { background: var(--error-bg); border: 1px solid var(--error-border); color: var(--error-color); }

        .tab-content { display: none; padding: 16px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); transition: background 0.3s, border-color 0.3s; }
        .card h3 { font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px; }

        #verdict { display: none; }
        .verdict-box { border-radius: 12px; padding: 14px; text-align: center; margin-bottom: 12px; }
        .verdict-box.good { background: var(--good-bg); border: 1px solid var(--good-border); }
        .verdict-box.warn { background: var(--warn-bg); border: 1px solid var(--warn-border); }
        .verdict-amount { display: block; font-size: 1.15em; font-weight: 800; }
        .verdict-box.good .verdict-amount { color: var(--green); }
        .verdict-box.warn .verdict-amount { color: var(--amber); }
        .verdict-desc { display: block; font-size: 0.78em; color: var(--text-muted); margin-top: 4px; }
        .verdict-sub-text { font-size: 0.72em; color: var(--text-faint); text-align: center; margin-bottom: 12px; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-box { background: var(--bg-muted); border: 1px solid var(--border-light); border-radius: 10px; padding: 12px; text-align: center; transition: background 0.3s; }
        .stat-box.payg { border-color: var(--payg-border); background: var(--payg-bg); }
        .stat-box.pass { border-color: var(--pass-border); background: var(--pass-bg); }
        .stat-label { font-size: 0.6em; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 1.25em; font-weight: 800; margin-top: 2px; }
        .stat-value.blue { color: var(--blue); } .stat-value.indigo { color: var(--indigo); }
        .stat-value.green { color: var(--green); } .stat-value.red { color: var(--red); } .stat-value.amber { color: var(--amber); }
        .stat-sub { font-size: 0.58em; color: var(--text-faint); margin-top: 2px; }
        .stats-row-4 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

        .cap-container { display: flex; align-items: center; gap: 16px; }
        .cap-ring-mobile { position: relative; width: 120px; height: 120px; flex-shrink: 0; }
        .cap-ring-mobile svg { transform: rotate(-90deg); }
        .cap-bg { stroke: var(--cap-bg-stroke); }
        .cap-progress { stroke: var(--blue); transition: all 0.5s; }
        .cap-progress.capped { stroke: var(--green); filter: drop-shadow(0 0 12px rgba(5,150,105,0.3)); }
        .cap-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cap-amount { font-size: 1.3em; font-weight: 800; color: var(--text); }
        .cap-label { font-size: 0.7em; color: var(--text-faint); }
        .cap-info { flex: 1; }
        .cap-status { padding: 10px 14px; border-radius: 10px; background: var(--cap-status-bg); border: 1px solid var(--cap-status-border); color: var(--cap-status-color); font-size: 0.85em; font-weight: 500; text-align: center; }
        .cap-status.capped { background: var(--cap-capped-bg); border-color: var(--cap-capped-border); color: var(--cap-capped-color); font-weight: 700; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .journey-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 10px; background: var(--bg-muted); margin-bottom: 6px; border: 1px solid transparent; transition: background 0.15s; }
        .journey-row.compact { padding: 8px 10px; }
        .journey-left { display: flex; align-items: center; gap: 10px; }
        .journey-icon { font-size: 1.1em; }
        .journey-desc { font-weight: 500; font-size: 0.85em; color: var(--text); }
        .journey-row.compact .journey-desc { font-size: 0.78em; }
        .journey-time { font-size: 0.7em; color: var(--text-faint); display: flex; align-items: center; gap: 4px; }
        .journey-right { display: flex; align-items: center; gap: 8px; }
        .journey-cost { font-weight: 700; font-size: 0.9em; color: var(--text); }
        .journey-row.compact .journey-cost { font-size: 0.8em; }
        .delete-btn { background: none; border: none; cursor: pointer; opacity: 0.3; font-size: 0.8em; }
        .tag { font-size: 0.6em; padding: 2px 5px; border-radius: 4px; font-weight: 600; }
        .tag.csv { background: var(--tag-bg); color: var(--tag-color); }

        .day-group { margin-bottom: 14px; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-wrap: wrap; gap: 6px; }
        .day-date { font-weight: 600; color: var(--text-secondary); font-size: 0.85em; }
        .day-meta { display: flex; align-items: center; gap: 6px; }
        .day-cost { font-weight: 700; font-size: 0.85em; color: var(--text); }
        .day-journeys { padding-left: 12px; }
        .cap-note { font-size: 0.7em; color: var(--green); font-weight: 500; }
        .badge { font-size: 0.62em; padding: 2px 8px; border-radius: 16px; font-weight: 600; }
        .badge.good { background: var(--badge-good-bg); color: var(--green); }
        .badge.warn { background: var(--badge-warn-bg); color: var(--amber); }

        .analysis-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; margin-bottom: 6px; }
        .analysis-row.good { background: var(--analysis-good-bg); border: 1px solid var(--analysis-good-border); }
        .analysis-row.warn { background: var(--analysis-warn-bg); border: 1px solid var(--analysis-warn-border); }
        .analysis-left { display: flex; align-items: center; gap: 10px; }
        .analysis-icon { font-size: 1em; }
        .analysis-date { font-weight: 600; font-size: 0.82em; color: var(--text); }
        .analysis-sub { font-size: 0.7em; color: var(--text-muted); }
        .analysis-right { text-align: right; }
        .analysis-cost { font-weight: 800; font-size: 0.88em; }
        .analysis-cost.good { color: var(--green); } .analysis-cost.warn { color: var(--amber); }
        .analysis-vs { font-size: 0.68em; color: var(--text-faint); }
        .analysis-cap { font-size: 0.68em; color: var(--blue); }

        .range-selector { display: flex; gap: 4px; margin-bottom: 10px; background: var(--bg-tab); padding: 3px; border-radius: 8px; width: fit-content; }
        .range-btn { padding: 5px 12px; border-radius: 6px; border: none; background: transparent; color: var(--text-faint); font-size: 0.72em; font-weight: 600; cursor: pointer; transition: all 0.15s; font-family: inherit; }
        .range-btn.active { background: var(--bg-tab-active); color: var(--text); box-shadow: var(--shadow); }

        .chart-container { min-height: 250px; }
        .chart-legend { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 8px; font-size: 0.72em; color: var(--text-muted); }
        .legend-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .legend-line { display: inline-block; width: 16px; height: 0; border-top: 2px dashed #d97706; margin-right: 4px; vertical-align: middle; }

        .empty-state { text-align: center; padding: 32px 16px; color: var(--text-faint); font-style: italic; font-size: 0.88em; }
        .empty-state small { font-size: 0.85em; color: var(--text-faintest); }

        .journey-option { width: 100%; display: flex; align-items: center; gap: 14px; padding: 16px; border-radius: 14px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); cursor: pointer; margin-bottom: 10px; transition: background 0.15s; font-size: 1em; text-align: left; font-family: inherit; }
        .journey-option:active { background: var(--bg-card-hover); transform: scale(0.98); }
        .journey-option .opt-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3em; }
        .journey-option .opt-label { font-weight: 600; }
        .journey-option .opt-sub { font-size: 0.78em; color: var(--text-faint); }
        .journey-option.bus { border-color: var(--good-border); } .journey-option.bus .opt-icon { background: var(--good-bg); } .journey-option.bus .opt-label { color: var(--green); }
        .journey-option.peak { border-color: var(--error-border); } .journey-option.peak .opt-icon { background: var(--error-bg); } .journey-option.peak .opt-label { color: var(--red); }
        .journey-option.offpeak { border-color: var(--payg-border); } .journey-option.offpeak .opt-icon { background: var(--payg-bg); } .journey-option.offpeak .opt-label { color: var(--blue); }

        .tab-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg); display: flex; border-top: 1px solid var(--border); z-index: 100; padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(20px); transition: background 0.3s; }
        .tab-btn { flex: 1; padding: 10px 4px; border: none; background: transparent; color: var(--text-faint); font-size: 0.62em; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; transition: all 0.15s; font-family: inherit; }
        .tab-btn.active { color: var(--nav-active); }
        .tab-btn .icon { font-size: 1.6em; }

        .scroll-panel { max-height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .desktop-link { text-align: center; padding: 16px; font-size: 0.8em; }
        .desktop-link a { color: #003688; text-decoration: none; }
        .hidden-input { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <div class="roundel-sm"><span>TfL</span></div>
                <h1>Spend & Savings</h1>
            </div>
            <div class="header-btns">
                <input type="file" id="csvInput" class="hidden-input" accept=".csv" onchange="handleCSVImport(event)">
                <button class="header-btn" onclick="document.getElementById('csvInput').click()">üì• CSV</button>
                <button class="header-btn" onclick="exportCSV()">üì§</button>
                <button id="themeToggle" class="header-btn" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
            </div>
        </div>
        <div class="quick-stats">
            <div class="mini-stat">
                <div class="label">Today's Spend</div>
                <div class="value blue" id="quickToday">¬£0.00</div>
                <div class="sub" id="quickTodayJourneys">0 journeys</div>
            </div>
            <div class="mini-stat" id="quickVerdictBox">
                <div class="label">Annual Pass</div>
                <div class="value green" id="quickVerdict">‚Äî</div>
                <div class="sub" id="quickVerdictSub">Import data to see</div>
            </div>
        </div>
    </div>

    <div class="google-bar">
        <div class="status-info">
            <div id="statusText">Not connected</div>
            <div id="lastSyncText"></div>
        </div>
        <div class="google-btns">
            <button class="g-btn sync" id="syncBtn" onclick="syncData()" style="display:none">üîÑ Sync</button>
            <button class="g-btn connect" id="connectBtn" onclick="authorizeGoogle()">Connect</button>
        </div>
    </div>

    <div id="importSummary" class="import-summary"></div>

    <div id="tabDashboard" class="tab-content active">
        <div id="verdict" class="card">
            <div id="verdictBox" class="verdict-box"></div>
            <div class="verdict-sub-text" id="verdictSub"></div>
            <div class="stats-row">
                <div class="stat-box payg"><div class="stat-label">PAYG Would Cost</div><div class="stat-value blue" id="statPayg">¬£0.00</div><div class="stat-sub" id="statPaygDays">0 travel days</div></div>
                <div class="stat-box pass"><div class="stat-label">Annual Pass Cost</div><div class="stat-value indigo" id="statPass">¬£0.00</div><div class="stat-sub" id="statPassDays">0 days</div></div>
            </div>
            <div class="stats-row-4">
                <div class="stat-box"><div class="stat-label">Pass Worth It</div><div class="stat-value green" id="statPassWin">0</div></div>
                <div class="stat-box"><div class="stat-label">PAYG Cheaper</div><div class="stat-value red" id="statPaygWin">0</div></div>
                <div class="stat-box"><div class="stat-label">No Travel</div><div class="stat-value amber" id="statNoTravel">0</div><div class="stat-sub" id="statNoTravelCost">¬£0 wasted</div></div>
                <div class="stat-box"><div class="stat-label">Journeys</div><div class="stat-value" id="statTotalJourneys">0</div><div class="stat-sub" id="statTotalJourneysSub">0 days</div></div>
            </div>
        </div>
        <div class="card">
            <h3>Today's Cap Meter</h3>
            <div class="cap-container">
                <div class="cap-ring-mobile">
                    <svg width="120" height="120">
                        <circle cx="60" cy="60" r="52" stroke-width="10" fill="none" class="cap-bg" />
                        <circle id="capCircle" cx="60" cy="60" r="52" stroke-width="10" fill="none" stroke-linecap="round" class="cap-progress" />
                    </svg>
                    <div class="cap-center">
                        <div id="capAmount" class="cap-amount">¬£0.00</div>
                        <div class="cap-label">of ¬£8.90</div>
                    </div>
                </div>
                <div class="cap-info"><div id="capStatus" class="cap-status">¬£8.90 until cap</div></div>
            </div>
        </div>
        <div class="card"><h3>Today's Journeys</h3><div id="todayList"></div></div>
    </div>

    <div id="tabAdd" class="tab-content">
        <div class="card">
            <h3>Log a Journey</h3>
            <button class="journey-option bus" onclick="addJourney('bus')"><span class="opt-icon">üöå</span><div><div class="opt-label">Bus</div><div class="opt-sub">¬£1.75 ¬∑ Hopper eligible</div></div></button>
            <button class="journey-option peak" onclick="addJourney('tube-peak')"><span class="opt-icon">üöá</span><div><div class="opt-label">Underground (Peak)</div><div class="opt-sub">¬£3.10 ¬∑ Weekday 6:30‚Äì9:30, 16:00‚Äì19:00</div></div></button>
            <button class="journey-option offpeak" onclick="addJourney('tube-offpeak')"><span class="opt-icon">üöá</span><div><div class="opt-label">Underground (Off-Peak)</div><div class="opt-sub">¬£3.00 ¬∑ All other times</div></div></button>
        </div>
        <div class="desktop-link"><a href="index.html">Switch to Desktop Version</a></div>
    </div>

    <div id="tabHistory" class="tab-content"><div class="card"><h3>Journey History</h3><div id="historyList" class="scroll-panel"></div></div></div>

    <div id="tabChart" class="tab-content">
        <div class="card">
            <h3>Daily PAYG Cost vs Annual Pass</h3>
            <div class="range-selector">
                <button class="range-btn" data-range="7" onclick="setChartRange(7)">7D</button>
                <button class="range-btn active" data-range="14" onclick="setChartRange(14)">14D</button>
                <button class="range-btn" data-range="30" onclick="setChartRange(30)">30D</button>
                <button class="range-btn" data-range="0" onclick="setChartRange(0)">All</button>
            </div>
            <div id="mobileChart" class="chart-container"></div>
            <div class="chart-legend">
                <span><span class="legend-dot" style="background:#059669"></span>Pass saved money</span>
                <span><span class="legend-dot" style="background:#dc2626"></span>PAYG cheaper</span>
                <span><span class="legend-line"></span>Pass: ¬£4.91/day</span>
            </div>
        </div>
    </div>

    <div id="tabAnalysis" class="tab-content"><div class="card"><h3>Daily Breakdown</h3><div id="analysisList" class="scroll-panel"></div></div></div>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="switchMobileTab('Dashboard', this)"><span class="icon">üè†</span><span>Home</span></button>
        <button class="tab-btn" onclick="switchMobileTab('Add', this)"><span class="icon">‚ûï</span><span>Add</span></button>
        <button class="tab-btn" onclick="switchMobileTab('History', this)"><span class="icon">üìã</span><span>History</span></button>
        <button class="tab-btn" onclick="switchMobileTab('Chart', this)"><span class="icon">üìä</span><span>Chart</span></button>
        <button class="tab-btn" onclick="switchMobileTab('Analysis', this)"><span class="icon">üîç</span><span>Analysis</span></button>
    </nav>

    <script src="app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script>
        function switchMobileTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-nav .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab' + tabName).classList.add('active');
            btn.classList.add('active');
            if (tabName === 'Chart') renderMobileChart();
        }

        const _origDisplayDashboard = displayDashboard;
        displayDashboard = function () {
            _origDisplayDashboard();
            updateMobileQuickStats();
        };

        function updateMobileQuickStats() {
            const todayCost = getTodayCost();
            const todayJourneys = getTodayJourneys();
            const summaries = getDailySummaries(journeys);
            const stats = getOverallStats(summaries);
            document.getElementById('quickToday').textContent = formatCurrency(todayCost);
            document.getElementById('quickTodayJourneys').textContent = `${todayJourneys.length} journeys`;
            if (journeys.length > 0) {
                const isPassWorthIt = stats.savings <= 0;
                const verdictEl = document.getElementById('quickVerdict');
                const verdictSub = document.getElementById('quickVerdictSub');
                if (isPassWorthIt) { verdictEl.textContent = '‚úÖ Worth it'; verdictEl.className = 'value green'; verdictSub.textContent = `Saving ${formatCurrency(Math.abs(stats.savings))}`; }
                else { verdictEl.textContent = '‚ö†Ô∏è Not yet'; verdictEl.className = 'value amber'; verdictSub.textContent = `PAYG saves ${formatCurrency(stats.savings)}`; }
            }
            updateMobileCapMeter(todayCost);
        }

        function updateMobileCapMeter(todayCost) {
            const capCircle = document.getElementById('capCircle');
            if (!capCircle) return;
            const r = 52, c = 2 * Math.PI * r, p = Math.min((todayCost / 8.90) * 100, 100);
            capCircle.style.strokeDasharray = c;
            capCircle.style.strokeDashoffset = c * (1 - p / 100);
            capCircle.setAttribute('class', todayCost >= 8.90 ? 'cap-progress capped' : 'cap-progress');
        }

        let mobileChartInstance = null;
        function renderMobileChart() {
            const summaries = getDailySummaries(journeys);
            const container = document.getElementById('mobileChart');
            if (!container || summaries.length < 2) return;
            const filtered = chartRange === 0 ? summaries : summaries.slice(0, chartRange);
            const reversed = [...filtered].reverse();
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const colors = reversed.map(s => s.passWorthIt ? (isDark ? '#34d399' : '#059669') : (isDark ? '#f87171' : '#dc2626'));
            if (mobileChartInstance) mobileChartInstance.destroy();
            const options = {
                series: [{ name: 'PAYG Cost', data: reversed.map(s => parseFloat(s.paygCost.toFixed(2))) }],
                chart: { type: 'bar', height: 250, toolbar: { show: false }, fontFamily: 'Inter, sans-serif', background: 'transparent' },
                plotOptions: { bar: { borderRadius: 3, columnWidth: '70%', distributed: true } },
                fill: { colors: colors },
                xaxis: { categories: reversed.map(s => s.dateShort), labels: { style: { colors: isDark ? '#64748b' : '#9ca3af', fontSize: '9px' }, rotate: -45, rotateAlways: summaries.length > 7 } },
                yaxis: { labels: { style: { colors: isDark ? '#64748b' : '#9ca3af' }, formatter: v => '¬£' + v.toFixed(0) } },
                grid: { borderColor: isDark ? 'rgba(255,255,255,0.08)' : '#e5e7eb', strokeDashArray: 4 },
                annotations: { yaxis: [{ y: DAILY_PASS, borderColor: '#d97706', borderWidth: 2, strokeDashArray: 6, label: { text: `Pass: ${formatCurrency(DAILY_PASS)}/day`, position: 'front', style: { color: '#fff', background: '#d97706', fontSize: '10px', padding: { left: 6, right: 6, top: 3, bottom: 3 } } } }] },
                dataLabels: { enabled: false }, legend: { show: false },
                tooltip: { theme: isDark ? 'dark' : 'light', y: { formatter: v => '¬£' + v.toFixed(2) } },
            };
            mobileChartInstance = new ApexCharts(container, options);
            mobileChartInstance.render();
        }
    </script>
</body>
</html>
